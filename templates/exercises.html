{% extends "base.html" %}

{% block title %}ç»ƒä¹ é¢˜ - Pythonå­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>ğŸ“ ç»ƒä¹ é¢˜</h1>
        <p>é€šè¿‡ç»ƒä¹ å·©å›ºæ‰€å­¦çŸ¥è¯†ï¼Œé€‰æ‹©å¯¹åº”ç« èŠ‚å¼€å§‹æŒ‘æˆ˜å§</p>
    </div>

    <!-- ç« èŠ‚ç­›é€‰ -->
    <div class="exercises-filter" id="filter-buttons">
        <button class="filter-btn active" data-lesson="0">å…¨éƒ¨</button>
        <button class="filter-btn" data-lesson="1">ç¬¬1ç«  PythonåŸºç¡€</button>
        <button class="filter-btn" data-lesson="2">ç¬¬2ç«  æ¡ä»¶ä¸å¾ªç¯</button>
        <button class="filter-btn" data-lesson="3">ç¬¬3ç«  å‡½æ•°ä¸æ–¹æ³•</button>
        <button class="filter-btn" data-lesson="4">ç¬¬4ç«  åˆ—è¡¨ä¸å­—å…¸</button>
        <button class="filter-btn" data-lesson="5">ç¬¬5ç«  ç±»ä¸å¯¹è±¡</button>
        <button class="filter-btn" data-lesson="6">ç¬¬6ç«  é¢å‘å¯¹è±¡</button>
        <button class="filter-btn" data-lesson="7">ç¬¬7ç«  å¼‚å¸¸å¤„ç†</button>
    </div>

    <div class="exercises-container" id="exercises-list">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>æ­£åœ¨åŠ è½½ç»ƒä¹ é¢˜...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allExercises = [];
const chapterNames = ['', 'PythonåŸºç¡€', 'æ¡ä»¶ä¸å¾ªç¯', 'å‡½æ•°ä¸æ–¹æ³•', 'åˆ—è¡¨ä¸å­—å…¸', 'ç±»ä¸å¯¹è±¡', 'é¢å‘å¯¹è±¡', 'å¼‚å¸¸å¤„ç†'];

document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½æ‰€æœ‰ç»ƒä¹ é¢˜
    loadExercises();

    // ç­›é€‰æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const lessonId = parseInt(this.dataset.lesson);
            filterExercises(lessonId);
        });
    });
});

function loadExercises() {
    fetch('/api/exercises')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allExercises = data.data;
                renderExercises(allExercises);
            } else {
                showError();
            }
        })
        .catch(error => {
            showError();
        });
}

function filterExercises(lessonId) {
    if (lessonId === 0) {
        renderExercises(allExercises);
    } else {
        const filtered = allExercises.filter(ex => ex.lesson_id === lessonId);
        renderExercises(filtered);
    }
}

function renderExercises(exercises) {
    const container = document.getElementById('exercises-list');

    if (exercises.length === 0) {
        container.innerHTML = '<p class="empty-message">è¯¥ç« èŠ‚æš‚æ— ç»ƒä¹ é¢˜</p>';
        return;
    }

    container.innerHTML = exercises.map(ex => `
        <a href="/exercises/${ex.id}" class="exercise-card">
            <div class="exercise-header">
                <h3 class="exercise-title">${ex.title}</h3>
                <span class="difficulty-badge difficulty-${ex.difficulty}">
                    ${['', 'ç®€å•', 'ä¸­ç­‰', 'å›°éš¾'][ex.difficulty] || 'æœªçŸ¥'}
                </span>
            </div>
            <p class="exercise-desc">${stripMarkdown(ex.description).substring(0, 80)}...</p>
            <div class="exercise-footer">
                <span class="exercise-chapter">ç¬¬${ex.lesson_id}ç«  Â· ${chapterNames[ex.lesson_id] || 'æœªçŸ¥'}</span>
                <span class="exercise-arrow">â†’</span>
            </div>
        </a>
    `).join('');
}

function stripMarkdown(text) {
    // ç®€å•å»é™¤Markdownæ ¼å¼
    return text
        .replace(/```[\s\S]*?```/g, '')
        .replace(/\*\*/g, '')
        .replace(/\*/g, '')
        .replace(/`/g, '')
        .replace(/\n/g, ' ')
        .trim();
}

function showError() {
    document.getElementById('exercises-list').innerHTML =
        '<p class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
}
</script>
{% endblock %}
