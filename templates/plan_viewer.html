{% extends "base.html" %}

{% block title %}è®¡åˆ’ä¹¦æŸ¥çœ‹å™¨ - SCF AI Copilot{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
    .plan-viewer-container {
        display: flex;
        min-height: calc(100vh - 120px);
        gap: 0;
    }

    .plan-sidebar {
        width: 220px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
        padding: 20px 0;
        flex-shrink: 0;
    }

    .plan-sidebar h4 {
        padding: 0 20px;
        margin: 0 0 15px 0;
        font-size: 0.95rem;
        color: #495057;
    }

    .plan-tab {
        display: block;
        padding: 12px 20px;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 0.9rem;
        color: #495057;
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }

    .plan-tab:hover {
        background: #e9ecef;
    }

    .plan-tab.active {
        background: #fff;
        border-left-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: 500;
    }

    .plan-tab .tab-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #dee2e6;
        color: #495057;
        font-size: 0.8rem;
        margin-right: 10px;
    }

    .plan-tab.active .tab-number {
        background: var(--primary-color);
        color: white;
    }

    .plan-content {
        flex: 1;
        padding: 30px 40px;
        overflow-y: auto;
        background: white;
    }

    .plan-content .markdown-body {
        max-width: 800px;
        line-height: 1.7;
    }

    .plan-content .markdown-body h1,
    .plan-content .markdown-body h2 {
        margin-top: 1.5em;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.3em;
    }

    .plan-loading {
        text-align: center;
        padding: 100px;
        color: #999;
    }

    .plan-loading .material-icons {
        font-size: 48px;
        color: #ddd;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: var(--text-secondary);
        text-decoration: none;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }

    .back-link:hover {
        color: var(--primary-color);
    }

    .plan-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .download-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .download-btn .material-icons {
        font-size: 18px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    <a href="/company/creative" class="back-link">
        <span class="material-icons" style="font-size: 18px;">arrow_back</span>
        è¿”å›åˆ›æ„ç”Ÿæˆå™¨
    </a>

    <div class="plan-header">
        <h2 style="margin: 0;">ğŸ“„ é¡¹ç›®è®¡åˆ’ä¹¦æŸ¥çœ‹å™¨</h2>
        <button class="download-btn" id="downloadBtn" onclick="downloadCurrentPlan()" disabled>
            <span class="material-icons">download</span>
            ä¸‹è½½å½“å‰è®¡åˆ’ä¹¦
        </button>
    </div>

    <div class="plan-viewer-container" id="viewerContainer">
        <div class="plan-sidebar" id="planSidebar">
            <h4>è®¡åˆ’ä¹¦åˆ—è¡¨</h4>
            <div id="planTabs">
                <div class="plan-loading">
                    <span class="material-icons">hourglass_empty</span>
                    <p>æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>
        </div>

        <div class="plan-content" id="planContent">
            <div class="plan-loading">
                <span class="material-icons">hourglass_empty</span>
                <p>æ­£åœ¨ç”Ÿæˆè®¡åˆ’ä¹¦ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js"></script>
<script>
    const parser = (typeof marked.parse === 'function') ? marked.parse : marked;

    // Load plans from sessionStorage
    const plansData = JSON.parse(sessionStorage.getItem('generatedPlans') || '[]');
    let currentPlanIndex = 0;

    function renderSidebar() {
        const tabsContainer = document.getElementById('planTabs');
        const downloadBtn = document.getElementById('downloadBtn');

        if (!plansData || plansData.length === 0) {
            tabsContainer.innerHTML = '<p style="padding: 0 20px; color: #999;">æ²¡æœ‰æ‰¾åˆ°è®¡åˆ’ä¹¦æ•°æ®ã€‚è¯·å…ˆé€‰æ‹©é¡¹ç›®å¹¶ç”Ÿæˆã€‚</p>';
            return;
        }

        tabsContainer.innerHTML = plansData.map((p, i) => `
            <button class="plan-tab ${i === 0 ? 'active' : ''}" onclick="showPlan(${i})">
                <span class="tab-number">${i + 1}</span>
                <span class="tab-name">${p.project_name || 'æ–¹æ¡ˆ ' + (i + 1)}</span>
            </button>
        `).join('');

        // Enable download button
        downloadBtn.disabled = false;

        // Show first plan by default
        if (plansData.length > 0) {
            showPlan(0);
        }
    }

    window.showPlan = function (index) {
        currentPlanIndex = index;

        // Update active tab
        document.querySelectorAll('.plan-tab').forEach((tab, i) => {
            tab.classList.toggle('active', i === index);
        });

        // Render content
        const contentContainer = document.getElementById('planContent');
        const plan = plansData[index];

        if (plan && plan.plan) {
            contentContainer.innerHTML = `
                <div class="markdown-body">
                    ${parser(plan.plan)}
                </div>
            `;
        } else {
            contentContainer.innerHTML = '<p style="color: #999;">æ— æ³•åŠ è½½æ­¤è®¡åˆ’ä¹¦ã€‚</p>';
        }
    };

    window.downloadCurrentPlan = function () {
        const plan = plansData[currentPlanIndex];
        if (!plan || !plan.plan) {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„è®¡åˆ’ä¹¦');
            return;
        }

        // Create filename
        const projectName = plan.project_name || 'é¡¹ç›®è®¡åˆ’ä¹¦';
        const filename = `${projectName}_è®¡åˆ’ä¹¦.md`;

        // Create download content
        const content = plan.plan;

        // Create blob and download
        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', renderSidebar);
</script>
{% endblock %}