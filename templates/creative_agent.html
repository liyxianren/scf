{% extends "base.html" %}

{% block title %}åˆ›æ„é¡¹ç›®ç”Ÿæˆå™¨ - SCF AI Copilot{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <a href="/company/agents" style="text-decoration: none; color: var(--text-secondary);">&larr; è¿”å›å¤§å…</a>
            <a href="/company/projects"
                style="text-decoration: none; color: var(--primary-color); margin-left: auto; display: flex; align-items: center; gap: 5px;">
                <span class="material-icons" style="font-size: 18px;">stars</span> æˆ‘çš„æ”¶è—
            </a>
        </div>
        <h1>åˆ›æ„é¡¹ç›®ç”Ÿæˆå™¨ (Creative Generator)</h1>
        <p>åŸºäº ChatGLM å¤§æ¨¡å‹ï¼Œè¾…åŠ©ç”Ÿæˆé«˜å¯è¡Œæ€§ã€æœ‰åˆ›æ„çš„å•†èµ›é¡¹ç›®ææ¡ˆ</p>
    </div>

    <div class="row" style="display: flex; gap: 30px; flex-wrap: wrap;">
        <!-- å·¦ä¾§è¾“å…¥åŒº -->
        <div class="col-md-5" style="flex: 1; min-width: 300px;">
            <div class="card"
                style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <form id="creativeForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="competition" style="display: block; margin-bottom: 8px; font-weight: 500;">ç›®æ ‡èµ›äº‹
                            (Target Competition)</label>
                        <select id="competition" class="form-control"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="Diamond Challenge">Diamond Challenge (é’»çŸ³æŒ‘æˆ˜èµ›)</option>
                            <option value="CTB">CTB (å…¨çƒåˆ›æ–°ç ”ç©¶å¤§æŒ‘æˆ˜)</option>
                            <option value="USAD">USAD (ç¾å›½å­¦æœ¯åé¡¹å…¨èƒ½)</option>
                            <option value="Yau Science Award">ä¸˜æˆæ¡ä¸­å­¦ç§‘å­¦å¥–</option>
                            <option value="Other">å…¶ä»–/é€šç”¨å•†ä¸šç±»</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="studentProfile" style="display: block; margin-bottom: 8px; font-weight: 500;">å­¦ç”Ÿç”»åƒ
                            (Student Profile)</label>
                        <textarea id="studentProfile" rows="3" placeholder="ä¾‹å¦‚ï¼šæ“…é•¿ç¼–ç¨‹çš„ç¯ä¿ä¸»ä¹‰è€…ï¼Œå–œæ¬¢ç”Ÿç‰©å­¦ï¼Œæœ‰äº›ç¤¾æ..."
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="keywords" style="display: block; margin-bottom: 8px; font-weight: 500;">æ ¸å¿ƒå…³é”®è¯
                            (Keywords)</label>
                        <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šç¯ä¿ + APP + AI + åƒåœ¾åˆ†ç±»"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 25px;">
                        <label for="extraReq" style="display: block; margin-bottom: 8px; font-weight: 500;">é¢å¤–è¦æ±‚ (Extra
                            Requirements)</label>
                        <textarea id="extraReq" rows="2" placeholder="ä¾‹å¦‚ï¼šå¿…é¡»åŒ…å«ç¡¬ä»¶åŸå‹ï¼Œæˆ–è€…æ˜¯çº¯å…¬ç›Šæ€§è´¨..."
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary"
                        style="width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.2s;">
                        <span class="material-icons"
                            style="vertical-align: middle; font-size: 18px; margin-right: 5px;">auto_awesome</span>
                        å¼€å§‹ç”Ÿæˆåˆ›æ„
                    </button>
                    <button type="button" id="brainstormStartBtn" class="btn btn-outline"
                        style="width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                        <span class="material-icons"
                            style="vertical-align: middle; font-size: 18px; margin-right: 5px;">psychology</span>
                        å¼€å¯å¤´è„‘é£æš´
                    </button>
                </form>
            </div>
        </div>

        <!-- å³ä¾§ç»“æœåŒº -->
        <div class="col-md-7" style="flex: 1.5; min-width: 300px;">
            <div class="card"
                style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-height: 500px;">
                <div id="outputHeader"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.2rem;">ç”Ÿæˆçš„é¡¹ç›®ææ¡ˆ</h3>
                    <div id="statusIndicator"
                        style="display: none; align-items: center; gap: 8px; color: var(--primary-color); font-size: 0.9em;">
                        <div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        <span>AI æ­£åœ¨æ€è€ƒä¸­...</span>
                    </div>
                </div>

                <div id="outputContent" class="markdown-body" style="line-height: 1.6; color: #333;">
                    <div style="text-align: center; color: #999; margin-top: 100px;">
                        <span class="material-icons" style="font-size: 48px; color: #eee;">light_mode</span>
                        <p>è¯·åœ¨å·¦ä¾§å¡«å†™ä¿¡æ¯ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®è·å–åˆ›æ„æ–¹æ¡ˆ</p>
                    </div>
                </div>
            </div>

            <!-- Old chat section removed -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
    }

    .markdown-body ul {
        padding-left: 20px;
    }

    .markdown-body blockquote {
        border-left: 4px solid #eee;
        padding-left: 15px;
        color: #666;
        margin: 0;
    }

    .btn-outline {
        background: white;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 5px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }

    .btn-outline:hover {
        background: var(--primary-color);
        color: white;
    }
</style>
<style>
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s;
    }

    .modal-content {
        width: 85%;
        height: 85%;
        background: white;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fcfcfc;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #333;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fff;
    }

    .modal-footer {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fcfcfc;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥ Markdown æ¸²æŸ“åº“ (UMDç‰ˆæœ¬ï¼Œç¡®ä¿å…¼å®¹æ€§) -->
<script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js"></script>

<!-- Chat Modal Structure -->
<div id="chatModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ğŸ’¬ æ–¹æ¡ˆä¼˜åŒ–ä¸è®¨è®º</h3>
            <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="chatHistory">
            <div style="color: #888; text-align: center; font-style: italic; margin-top: 100px;">
                æ­£åœ¨è¿æ¥ AI é¡¾é—®...
            </div>
        </div>
        <div class="modal-footer">
            <input type="text" id="chatInput" class="form-control" placeholder="è¾“å…¥æ‚¨çš„æƒ³æ³•..."
                style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
            <button id="sendChatBtn" class="btn-primary"
                style="padding: 10px 25px; border: none; border-radius: 8px;">å‘é€</button>
        </div>
    </div>
</div>

<script>
    function loadIdeaHistory() {
        try {
            const raw = localStorage.getItem('creativeIdeaHistory');
            const parsed = raw ? JSON.parse(raw) : [];
            return Array.isArray(parsed) ? parsed : [];
        } catch (err) {
            console.warn('Failed to load history:', err);
            return [];
        }
    }

    function saveIdeaHistory(ideas) {
        const trimmed = ideas.slice(0, 20);
        localStorage.setItem('creativeIdeaHistory', JSON.stringify(trimmed));
    }

    function extractProjectNames(report) {
        const ideas = [];
        const lines = report.split('\n');
        for (const line of lines) {
            const nameMatch = line.match(/\*\*é¡¹ç›®åç§°\*\*[:ï¼š]\s*(.+)/);
            if (nameMatch) {
                ideas.push(nameMatch[1].trim());
                continue;
            }
            const headingMatch = line.match(/^##\s+(.+)/);
            if (headingMatch && !headingMatch[1].includes('æ¨èé¡¹ç›®æ–¹æ¡ˆ')) {
                ideas.push(headingMatch[1].trim());
            }
        }
        return ideas;
    }

    window.ideaHistory = loadIdeaHistory();
    window.brainstormState = {
        report: '',
        avoidTopics: [],
        summary: ''
    };

    function setLoadingState(isLoading) {
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = statusIndicator.querySelector('span');
        const submitBtn = document.querySelector('#creativeForm button[type="submit"]');
        const brainstormBtn = document.getElementById('brainstormStartBtn');

        statusIndicator.style.display = isLoading ? 'flex' : 'none';
        statusText.innerText = isLoading ? "AI æ­£åœ¨æ·±åº¦æ€è€ƒä¸­ (é¢„è®¡éœ€ 30-60 ç§’)..." : "";
        submitBtn.disabled = isLoading;
        brainstormBtn.disabled = isLoading;
    }

    function handleReportResult(report) {
        const outputContent = document.getElementById('outputContent');
        const parser = (typeof marked.parse === 'function') ? marked.parse : marked;
        outputContent.innerHTML = parser(report);

        const actionArea = document.getElementById('actionArea');
        if (actionArea) actionArea.style.display = 'block';
        else createActionArea();

        window.currentReportContext = report;
        const newIdeas = extractProjectNames(report);
        if (newIdeas.length) {
            window.ideaHistory = [...newIdeas, ...window.ideaHistory].filter((value, index, self) => self.indexOf(value) === index);
            saveIdeaHistory(window.ideaHistory);
        }
    }

    function parseApiResponse(response) {
        const contentType = response.headers.get('content-type') || '';

        return response.text().then(text => {
            let parsed = null;
            if (text) {
                try {
                    parsed = JSON.parse(text);
                } catch (err) {
                    parsed = null;
                }
            }

            if (!response.ok) {
                if (parsed) {
                    throw parsed;
                }
                const message = text || response.statusText || 'Unexpected response';
                throw new Error(message);
            }

            if (parsed) {
                return parsed;
            }

            if (contentType.includes('application/json')) {
                throw new Error('Invalid JSON response');
            }

            throw new Error(text || response.statusText || 'Unexpected response');
        });
    }

    function getErrorMessage(err) {
        if (!err) return 'æœªçŸ¥é”™è¯¯';
        if (typeof err === 'string') return err;
        if (err.error) return err.error;
        if (err.message) return err.message;
        return JSON.stringify(err);
    }

    document.getElementById('creativeForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // è·å–è¡¨å•æ•°æ®
        const data = {
            competition: document.getElementById('competition').value,
            studentProfile: document.getElementById('studentProfile').value,
            keywords: document.getElementById('keywords').value,
            extraReq: document.getElementById('extraReq').value,
            historyIdeas: window.ideaHistory
        };

        // UI çŠ¶æ€æ›´æ–°
        const outputContent = document.getElementById('outputContent');
        const actionArea = document.getElementById('actionArea');

        outputContent.innerHTML = '';
        if (actionArea) actionArea.style.display = 'none';
        setLoadingState(true);

        // è°ƒç”¨åç«¯ API
        fetch('/company/creative/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(parseApiResponse)
            .then(result => {
                if (result.error) {
                    outputContent.innerHTML = `<p style="color: red;">ç”Ÿæˆå‡ºé”™: ${result.error}</p>`;
                } else {
                    const report = result.report;
                    handleReportResult(report);
                }
            })
            .catch(err => {
                outputContent.innerHTML = `<p style="color: red;">ç½‘ç»œè¯·æ±‚å‡ºé”™: ${getErrorMessage(err)}</p>`;
            })
            .finally(() => {
                setLoadingState(false);
            });
    });

    document.getElementById('brainstormStartBtn').addEventListener('click', () => {
        const outputContent = document.getElementById('outputContent');
        const actionArea = document.getElementById('actionArea');
        outputContent.innerHTML = '';
        if (actionArea) actionArea.style.display = 'none';
        setLoadingState(true);

        const data = {
            competition: document.getElementById('competition').value,
            studentProfile: document.getElementById('studentProfile').value,
            keywords: document.getElementById('keywords').value,
            extraReq: document.getElementById('extraReq').value,
            historyIdeas: window.ideaHistory,
            avoidTopics: window.brainstormState.avoidTopics,
            previousReport: window.brainstormState.report
        };

        fetch('/company/creative/brainstorm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(parseApiResponse)
            .then(result => {
                if (result.error) {
                    outputContent.innerHTML = `<p style="color: red;">ç”Ÿæˆå‡ºé”™: ${result.error}</p>`;
                    return;
                }
                window.brainstormState = {
                    report: result.report || '',
                    summary: result.summary || '',
                    avoidTopics: result.avoidTopics || []
                };
                handleReportResult(result.report);
                renderBrainstormControls();
            })
            .catch(err => {
                outputContent.innerHTML = `<p style="color: red;">ç½‘ç»œè¯·æ±‚å‡ºé”™: ${getErrorMessage(err)}</p>`;
            })
            .finally(() => {
                setLoadingState(false);
            });
    });

    function renderBrainstormControls() {
        const container = document.getElementById('outputContent').parentNode;
        let div = document.getElementById('brainstormControls');
        if (!div) {
            div = document.createElement('div');
            div.id = 'brainstormControls';
            div.style.marginTop = '20px';
            div.style.paddingTop = '20px';
            div.style.borderTop = '1px solid #eee';
            container.appendChild(div);
        }

        div.innerHTML = `
            <h4 style="margin-bottom: 10px;">ğŸ§  ç»§ç»­å¤´è„‘é£æš´</h4>
            <textarea id="brainstormFeedback" rows="2" placeholder="å¯é€‰ï¼šè¾“å…¥ä½ çš„ä¿®æ”¹å»ºè®®ï¼ˆæ¯”å¦‚ä¸å–œæ¬¢çš„æ–¹å‘/æƒ³è¦çš„æ”¹åŠ¨ï¼‰"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button class="btn-outline" onclick="runBrainstormCycle()">å†æ¬¡å¤´è„‘é£æš´</button>
                <span style="color: #999; font-size: 0.85em;">å°†è‡ªåŠ¨é¿å¼€ä¸Šä¸€è½®æ€»ç»“çš„é‡å¤æ–¹å‘</span>
            </div>
        `;
    }

    window.runBrainstormCycle = function () {
        const outputContent = document.getElementById('outputContent');
        const feedbackInput = document.getElementById('brainstormFeedback');
        const feedback = feedbackInput ? feedbackInput.value.trim() : '';

        outputContent.innerHTML = '';
        setLoadingState(true);

        const data = {
            competition: document.getElementById('competition').value,
            studentProfile: document.getElementById('studentProfile').value,
            keywords: document.getElementById('keywords').value,
            extraReq: document.getElementById('extraReq').value,
            historyIdeas: window.ideaHistory,
            avoidTopics: window.brainstormState.avoidTopics,
            previousReport: window.brainstormState.report,
            feedback: feedback
        };

        fetch('/company/creative/brainstorm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(parseApiResponse)
            .then(result => {
                if (result.error) {
                    outputContent.innerHTML = `<p style="color: red;">ç”Ÿæˆå‡ºé”™: ${result.error}</p>`;
                    return;
                }
                window.brainstormState = {
                    report: result.report || '',
                    summary: result.summary || '',
                    avoidTopics: result.avoidTopics || []
                };
                handleReportResult(result.report);
                renderBrainstormControls();
                if (feedbackInput) feedbackInput.value = '';
            })
            .catch(err => {
                outputContent.innerHTML = `<p style="color: red;">ç½‘ç»œè¯·æ±‚å‡ºé”™: ${getErrorMessage(err)}</p>`;
            })
            .finally(() => {
                setLoadingState(false);
            });
    };

    function createActionArea() {
        const container = document.getElementById('outputContent').parentNode;
        let div = document.getElementById('actionArea');
        if (!div) {
            div = document.createElement('div');
            div.id = 'actionArea';
            div.style.marginTop = '20px';
            div.style.paddingTop = '20px';
            div.style.borderTop = '1px solid #eee';
            container.appendChild(div);
        }

        div.innerHTML = `
            <h4 style="margin-bottom: 15px;">ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button class="btn-outline" onclick="openOptimization(1)">ä¼˜åŒ–æ–¹æ¡ˆ 1 (å·¥å…·ç±»)</button>
                <button class="btn-outline" onclick="openOptimization(2)">ä¼˜åŒ–æ–¹æ¡ˆ 2 (å¹³å°ç±»)</button>
                <button class="btn-outline" onclick="openOptimization(3)">ä¼˜åŒ–æ–¹æ¡ˆ 3 (ç¡¬ä»¶ç±»)</button>
                <button class="btn-outline" style="border-color: #666; color: #666;" onclick="openOptimization(0)">ğŸ’¬ è‡ªç”±è®¨è®º</button>
                <div style="flex: 1;"></div>
                <button class="btn-primary" onclick="saveProject()" style="padding: 6px 15px; border-radius: 20px; font-size: 0.9em; display: flex; align-items: center; gap: 5px;">
                    <span class="material-icons" style="font-size: 16px;">favorite</span> æ”¶è—æ–¹æ¡ˆ
                </button>
            </div>
        `;
    }

    // Save Project Logic
    window.saveProject = function () {
        const content = window.currentReportContext;
        if (!content) { alert("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹ï¼"); return; }

        // Simple extraction of Title
        const titleMatch = content.match(/#\s*(.+)/) || content.match(/\*\*(.+)\*\*/);
        const title = titleMatch ? titleMatch[1].replace(/[:ï¼š]/g, '').trim() : "AI åˆ›æ„é¡¹ç›®";

        fetch('/company/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                content: content,
                tags: "AI Generated"
            })
        })
            .then(parseApiResponse)
            .then(data => {
                alert("âœ… é¡¹ç›®å·²æ”¶è—åˆ°å¯¹åº”é¡µé¢ï¼");
            })
            .catch(err => alert("ä¿å­˜å¤±è´¥: " + getErrorMessage(err)));
    };

    // Modal & Chat Logic
    const chatModal = document.getElementById('chatModal');
    const chatHistory = document.getElementById('chatHistory');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');

    function openModal() {
        chatModal.style.display = 'flex';
        chatInput.focus();
    }

    function closeModal() {
        chatModal.style.display = 'none';
    }

    // Close when clicking outside
    chatModal.addEventListener('click', (e) => {
        if (e.target === chatModal) closeModal();
    });

    function appendMessage(role, text) {
        const msgDiv = document.createElement('div');
        msgDiv.style.margin = "10px 0";
        msgDiv.style.padding = "12px 16px";
        msgDiv.style.borderRadius = "12px";
        msgDiv.style.maxWidth = "85%";
        msgDiv.style.lineHeight = "1.5";

        if (role === 'user') {
            msgDiv.style.background = "#e3f2fd";
            msgDiv.style.marginLeft = "auto";
            msgDiv.style.color = "#000";
            msgDiv.innerHTML = `<strong>You:</strong> ${text}`;
        } else {
            msgDiv.style.background = "#f4f6f8";
            msgDiv.style.marginRight = "auto";
            const parser = (typeof marked.parse === 'function') ? marked.parse : marked;
            msgDiv.innerHTML = parser(text); // AI text is markdown
        }

        chatHistory.appendChild(msgDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function sendChat(message) {
        if (!message) return;

        appendMessage('user', message);
        chatInput.value = '';

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'chatLoading';
        loadingDiv.innerText = "AI æ­£åœ¨æ€è€ƒä¸­...";
        loadingDiv.style.padding = "12px";
        loadingDiv.style.color = "#999";
        chatHistory.appendChild(loadingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        fetch('/company/creative/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                context: window.currentReportContext || ""
            })
        })
            .then(parseApiResponse)
            .then(data => {
                if (document.getElementById('chatLoading')) document.getElementById('chatLoading').remove();
                if (data.reply) {
                    appendMessage('ai', data.reply);

                    // Update Context if reply looks like a new report (Auto-Update Logic)
                    // Heuristic: Length > 200 and contains Headers
                    if (data.reply.length > 200 && (data.reply.includes("# ") || data.reply.includes("### "))) {
                        console.log("Updating context with new report...");
                        window.currentReportContext = data.reply;

                        // Add a mini notification in chat
                        const updateDiv = document.createElement('div');
                        updateDiv.style.textAlign = 'center';
                        updateDiv.style.fontSize = '0.8em';
                        updateDiv.style.color = '#10b981';
                        updateDiv.style.margin = '10px 0';
                        updateDiv.innerHTML = 'ğŸ’¾ ç³»ç»Ÿæ£€æµ‹åˆ°æ–°æ–¹æ¡ˆï¼Œç‚¹å‡»ä¸»ç•Œé¢çš„â€œæ”¶è—â€å³å¯ä¿å­˜æ­¤ç‰ˆæœ¬ã€‚';
                        chatHistory.appendChild(updateDiv);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    }
                } else {
                    appendMessage('ai', data.error || "Error generating reply.");
                }
            })
            .catch(err => {
                if (document.getElementById('chatLoading')) document.getElementById('chatLoading').remove();
                appendMessage('ai', `Error: ${getErrorMessage(err)}`);
            });
    }

    // Trigger Optimization
    window.openOptimization = function (idx) {
        openModal();
        // Clear history if it's a fresh session or just append separator? 
        // Let's clear for better focus if user switches context, or keep it?
        // User might want to compare. Let's keep history but add a divider or system note.

        let msg = "";
        if (idx === 0) {
            document.getElementById('modalTitle').innerText = "ğŸ’¬ è‡ªç”±è®¨è®ºæ¨¡å¼";
            // Don't auto send, just ready
            chatHistory.innerHTML = '<div style="text-align:center; color:#999; margin: 20px;">å·²è¿›å…¥è‡ªç”±è®¨è®ºæ¨¡å¼ï¼Œè¯·ç›´æ¥æé—®ã€‚</div>';
        } else {
            document.getElementById('modalTitle').innerText = `ğŸš€ æ­£åœ¨ä¼˜åŒ–ï¼šæ–¹æ¡ˆ ${idx}`;
            chatHistory.innerHTML = ''; // Start fresh for specific optimization
            msg = `æˆ‘å¯¹æ–¹æ¡ˆ ${idx} å¾ˆæ„Ÿå…´è¶£ã€‚è¯·æ‹…ä»»æŠ€æœ¯é¡¾é—®ï¼Œè¯¦ç»†åˆ—å‡ºå®ƒçš„è½åœ°æ‰§è¡Œæ­¥éª¤ï¼ˆRoadmapï¼‰ï¼Œå¹¶åˆ†ææ½œåœ¨çš„æŠ€æœ¯éš¾ç‚¹ï¼ˆTech Challengesï¼‰ã€‚`;
            sendChat(msg);
        }
    };

    sendChatBtn.addEventListener('click', () => sendChat(chatInput.value));
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat(chatInput.value);
    });
</script>
{% endblock %}
